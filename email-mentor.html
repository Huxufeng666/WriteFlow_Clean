<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="page-title-mentor">é‚®ä»¶å†™ä½œå¯¼å¸ˆ (Email Writing Mentor)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* é’ˆå¯¹ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–ï¼Œç¡®ä¿ä¸»ä½“å†…å®¹å±…ä¸­ä¸”ä¸æ‹¥æŒ¤ */
        .main-container {
            max-width: 95%;
            margin: 0 auto;
            padding: 1rem;
        }
        @media (min-width: 768px) { /* md */
            .main-container {
                max-width: 1280px; /* xl */
                padding: 2rem;
            }
        }
        .loading-animation {
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* è¯­è¨€åˆ‡æ¢å™¨æ ·å¼ */
        .lang-switcher { display: flex; background-color: #e9ecef; border-radius: 8px; padding: 4px; }
        .lang-btn { background-color: transparent; border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; color: #555; transition: all 0.3s ease; }
        .lang-btn.active { background-color: #ffffff; color: #db631d; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <header class="text-center py-6 bg-white rounded-xl shadow-lg mt-4 mb-8 relative">
            <a href="/" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </a>
            <h1 class="text-3xl font-bold text-gray-900" data-lang-key="mentor-header-title">é‚®ä»¶å†™ä½œå¯¼å¸ˆ ğŸ“§</h1>
            <p class="mt-2 text-gray-500" data-lang-key="mentor-header-subtitle">ä¸€ç«™å¼è§£å†³èŒåœºå’Œå­¦æœ¯é‚®ä»¶éš¾é¢˜</p>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 lang-switcher">
                <button id="btn-zh" class="lang-btn active">ä¸­æ–‡</button>
                <button id="btn-ko" class="lang-btn">í•œêµ­ì–´</button>
            </div>
        </header>

        <!-- ä¸»é¢æ¿ -->
        <div id="email-app" class="flex flex-col lg:flex-row gap-6">
            
            <!-- å·¦ä¾§ï¼šè¾“å…¥æ§åˆ¶é¢æ¿ -->
            <div class="lg:w-1/3 p-4 bg-white rounded-xl shadow-lg h-full sticky top-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2" data-lang-key="mentor-panel-title">å†™ä½œå‚æ•°</h2>
                
                <!-- æ¨¡å¼é€‰æ‹© -->
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-function">é€‰æ‹©åŠŸèƒ½</label>
                    <select id="mode-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                        <option value="generate" data-lang-key="mentor-option-generate">ç”Ÿæˆæ–°è‰ç¨¿ (Generate)</option>
                        <option value="analyze" data-lang-key="mentor-option-analyze">åˆ†æå’Œå»ºè®® (Analyze)</option>
                        <option value="refine" data-lang-key="mentor-option-refine">æ¶¦è‰²å’Œé‡å†™ (Refine)</option>
                    </select>
                </div>
                
                <!-- ä»…ç”Ÿæˆæ¨¡å¼å¯è§çš„å­—æ®µ -->
                <div id="generate-fields">
                    <div class="mb-5">
                        <label for="recipient-select" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-recipient">æ”¶ä»¶äºº/æƒ…å¢ƒ</label>
                        <select id="recipient-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Professor" data-lang-key="mentor-recipient-professor">æ•™æˆ/å¯¼å¸ˆ (Professor/Mentor)</option>
                            <option value="Manager" data-lang-key="mentor-recipient-manager">ç»ç†/è€æ¿ (Manager/Boss)</option>
                            <option value="Client" data-lang-key="mentor-recipient-client">å®¢æˆ·/å¤–éƒ¨åˆä½œæ–¹ (Client/Partner)</option>
                            <option value="Colleague" data-lang-key="mentor-recipient-colleague">åŒäº‹/åŒå­¦ (Colleague/Classmate)</option>
                            <option value="Job Application" data-lang-key="mentor-recipient-job">æ±‚èŒç”³è¯· (Job Application)</option>
                            <option value="Complaint/Request" data-lang-key="mentor-recipient-request">æŠ•è¯‰/æ­£å¼è¯·æ±‚ (Complaint/Request)</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label for="tone-select" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-tone">æœŸæœ›è¯­æ°”</label>
                        <select id="tone-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Formal" data-lang-key="mentor-tone-formal">æ­£å¼ã€ä¸“ä¸š (Formal, Professional)</option>
                            <option value="Casual" data-lang-key="mentor-tone-casual">éæ­£å¼ã€è½»æ¾ (Casual, Friendly)</option>
                            <option value="Persuasive" data-lang-key="mentor-tone-persuasive">è¯´æœæ€§ã€æœ‰æ¡ç† (Persuasive, Organized)</option>
                            <option value="Concise" data-lang-key="mentor-tone-concise">ç®€æ´ã€ç›´æ¥ (Concise, Direct)</option>
                            <option value="Apologetic" data-lang-key="mentor-tone-apologetic">è‡´æ­‰ã€è¯šæ³ (Apologetic, Sincere)</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-intent">é‚®ä»¶æ„å›¾ï¼ˆè¯´æ˜ä½ çš„ç›®çš„ï¼‰</label>
                        <textarea id="prompt-input" rows="4" data-lang-key="mentor-placeholder-intent" placeholder="ä¾‹å¦‚ï¼šè¯·æ±‚æ•™æˆå»¶é•¿æ¯•ä¸šè®ºæ–‡æäº¤æœŸé™ï¼Œå¹¶è¯´æ˜åŸå› ã€‚" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow"></textarea>
                    </div>
                </div>

                <!-- ä»…åˆ†æ/æ¶¦è‰²æ¨¡å¼å¯è§çš„å­—æ®µ -->
                <div id="draft-fields" class="hidden">
                     <div class="mb-5">
                        <label for="draft-textarea" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-draft">ç²˜è´´æ‚¨çš„é‚®ä»¶è‰ç¨¿</label>
                        <textarea id="draft-textarea" rows="8" data-lang-key="mentor-placeholder-draft" placeholder="ç²˜è´´å®Œæ•´çš„é‚®ä»¶å†…å®¹ï¼ŒåŒ…æ‹¬ä¸»é¢˜å’Œæ­£æ–‡..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow"></textarea>
                    </div>
                    <!-- ä»…æ¶¦è‰²æ¨¡å¼å¯è§çš„å­—æ®µ -->
                    <div class="mb-5 hidden" id="refinement-field">
                        <label for="refinement-prompt" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="mentor-label-refine-prompt">æ¶¦è‰²è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <input id="refinement-prompt" type="text" data-lang-key="mentor-placeholder-refine-prompt" placeholder="ä¾‹å¦‚ï¼šè®©è¯­æ°”æ›´å§”å©‰ï¼›å°†é‚®ä»¶ç¼©çŸ­åˆ°100å­—ä»¥å†…" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                    </div>
                </div>


                <!-- æäº¤æŒ‰é’® -->
                <button id="submit-button" class="w-full bg-orange-600 text-white p-3 rounded-xl font-semibold hover:bg-orange-700 transition-colors shadow-md">
                    <span data-lang-key="mentor-submit-btn">å¼€å§‹å¤„ç†</span>
                </button>
            </div>

            <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒº -->
            <div class="lg:w-2/3">
                <div class="p-6 bg-white rounded-xl shadow-lg min-h-[300px]">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2" data-lang-key="mentor-output-title">è¾“å‡ºç»“æœ</h2>
                    
                    <!-- ç»“æœæ˜¾ç¤º/åŠ è½½ä¸­ -->
                    <div id="output-area" class="text-gray-700 whitespace-pre-wrap leading-relaxed">
                        <p class="text-gray-500 text-center py-10" data-lang-key="mentor-output-placeholder">è¯·åœ¨å·¦ä¾§é€‰æ‹©æ¨¡å¼å¹¶è¾“å…¥å‚æ•°ï¼Œç„¶åç‚¹å‡» "å¼€å§‹å¤„ç†" æŒ‰é’®ã€‚</p>
                    </div>

                    <!-- é”™è¯¯ä¿¡æ¯ -->
                    <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <span data-lang-key="mentor-error-default">å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // --- Firebase é…ç½®å’Œåˆå§‹åŒ– (è™½ç„¶æœ¬åº”ç”¨ä¸ä½¿ç”¨ Firestoreï¼Œä½†ä¸ºäº†ç¬¦åˆ Canvas è§„èŒƒï¼Œä¿ç•™åˆå§‹åŒ–) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        // ä»…ç”¨äºæ»¡è¶³ Canvas åˆå§‹åŒ–çš„è¦æ±‚ï¼Œæœ¬åº”ç”¨ä¸ä¾èµ–äº Firestore æˆ– Auth çŠ¶æ€
        if (firebaseConfig) {
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js").then(({ initializeApp }) => {
                import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js").then(({ getAuth, signInAnonymously, signInWithCustomToken }) => {
                    import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").then(({ getFirestore }) => {
                        try {
                            const app = initializeApp(firebaseConfig);
                            const db = getFirestore(app);
                            const auth = getAuth(app);
                            
                            const initAuth = async () => {
                                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                console.log("Firebase auth initialized.");
                            };
                            initAuth();
                        } catch (e) {
                            console.error("Firebase init failed:", e);
                        }
                    });
                });
            });
        }
        
        // --- æ ¸å¿ƒ JavaScript é€»è¾‘ ---
        
        // API å¯†é’¥å’Œ URLï¼ˆåœ¨ Canvas ç¯å¢ƒä¸­ä¼šè‡ªåŠ¨æä¾›ï¼‰
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        // å…ƒç´ å¼•ç”¨
        const modeSelect = document.getElementById('mode-select');
        const generateFields = document.getElementById('generate-fields');
        const draftFields = document.getElementById('draft-fields');
        const refinementField = document.getElementById('refinement-field');
        const submitButton = document.getElementById('submit-button');
        const outputArea = document.getElementById('output-area');
        const errorMessage = document.getElementById('error-message');

        const recipientSelect = document.getElementById('recipient-select');
        const toneSelect = document.getElementById('tone-select');
        const promptInput = document.getElementById('prompt-input');
        const draftTextarea = document.getElementById('draft-textarea');
        const refinementPrompt = document.getElementById('refinement-prompt');

        // --- UI çŠ¶æ€ç®¡ç† ---
        modeSelect.addEventListener('change', () => {
            const mode = modeSelect.value;
            generateFields.classList.add('hidden');
            draftFields.classList.add('hidden');
            refinementField.classList.add('hidden');

            if (mode === 'generate') {
                generateFields.classList.remove('hidden');
            } else {
                draftFields.classList.remove('hidden');
                if (mode === 'refine') {
                    refinementField.classList.remove('hidden');
                }
            }
            const placeholder = document.createElement('p');
            placeholder.className = "text-gray-500 text-center py-10";
            placeholder.setAttribute('data-lang-key', 'mentor-output-placeholder');
            placeholder.textContent = 'è¯·åœ¨å·¦ä¾§é€‰æ‹©æ¨¡å¼å¹¶è¾“å…¥å‚æ•°ï¼Œç„¶åç‚¹å‡» "å¼€å§‹å¤„ç†" æŒ‰é’®ã€‚';
            outputArea.innerHTML = '';
            outputArea.appendChild(placeholder);
        });

        // åˆå§‹åŒ–UI
        modeSelect.dispatchEvent(new Event('change'));

        // --- API è°ƒç”¨å’Œä¸»é€»è¾‘ ---
        let retryCount = 0;
        const MAX_RETRIES = 5;

        async function fetchWithRetry(payload) {
            let delay = 1000;
            while (retryCount < MAX_RETRIES) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        retryCount = 0; // é‡ç½®è®¡æ•°å™¨
                        return response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        // å¤„ç†é€Ÿç‡é™åˆ¶å’ŒæœåŠ¡å™¨é”™è¯¯
                        throw new Error(`API Error: ${response.status}`);
                    } else {
                         // å…¶ä»–å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¸é‡è¯•
                        console.error("Non-retryable API error:", response.status);
                        return response.json();
                    }
                } catch (error) {
                    retryCount++;
                    if (retryCount >= MAX_RETRIES) {
                        throw new Error("APIè¯·æ±‚å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚");
                    }
                    console.log(`Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // æŒ‡æ•°é€€é¿
                }
            }
        }

        async function handleEmailProcessing() {
            errorMessage.classList.add('hidden');
            outputArea.innerHTML = `<div class="flex flex-col items-center justify-center py-10">
                                        <div class="loading-animation w-8 h-8 border-4 border-orange-500 rounded-full mb-3"></div>
                                        <p class="text-orange-600 font-medium" data-lang-key="mentor-loading-text">AI æ­£åœ¨åŠªåŠ›æ’°å†™ä¸­...</p>
                                    </div>`;
            submitButton.disabled = true;

            const mode = modeSelect.value;
            let systemPrompt = "";
            let userQuery = "";
            
            // --- æ„é€ æç¤ºè¯å’Œç³»ç»ŸæŒ‡ä»¤ ---
            try {
                if (mode === 'generate') {
                    const recipient = recipientSelect.options[recipientSelect.selectedIndex].text;
                    const tone = toneSelect.options[toneSelect.selectedIndex].text;
                    const intent = promptInput.value.trim();

                    if (!intent) throw new Error(translations[currentLanguage]['mentor-error-no-intent'] || "è¯·è¾“å…¥é‚®ä»¶æ„å›¾ã€‚");

                    systemPrompt = "You are a professional email writing assistant. Based on the user's provided intent, recipient, and tone, generate a complete, well-structured, and appropriate email (including subject, salutation, body, and closing). All output must be in English.";
                    userQuery = `Please write an email for the following scenario:
- Recipient/Context: ${recipient}
- Desired Tone: ${tone}
- Intent: ${intent}
Please output only the email content, without any extra explanation.`;
                } else if (mode === 'analyze') {
                    const draft = draftTextarea.value.trim();
                    if (!draft) throw new Error(translations[currentLanguage]['mentor-error-no-draft-analyze'] || "è¯·ç²˜è´´è¦åˆ†æçš„é‚®ä»¶è‰ç¨¿ã€‚");

                    systemPrompt = "You are a professional email analyst. Please provide a comprehensive evaluation of the user's email draft. The evaluation should cover subject clarity, tone appropriateness, body structure, and language professionalism. Start with 'Email Analysis Report', provide an overall assessment, and then give 3-5 specific suggestions for improvement in a bulleted list.";
                    userQuery = `Please analyze and provide suggestions for improvement:\n\n${draft}`;

                } else if (mode === 'refine') {
                    const draft = draftTextarea.value.trim();
                    const refinement = refinementPrompt.value.trim() || "Refine it to be more fluent and professional";
                    if (!draft) throw new Error(translations[currentLanguage]['mentor-error-no-draft-refine'] || "è¯·ç²˜è´´è¦æ¶¦è‰²çš„é‚®ä»¶è‰ç¨¿ã€‚");
                    
                    systemPrompt = "You are a professional email copyeditor. Please rewrite and optimize the user's provided email based on their request. Ensure the rewritten email is well-structured and has an appropriate tone.";
                    userQuery = `Please rewrite the email based on the following requirements:\n
- Original Email:\n${draft}\n
- Refinement Request: ${refinement}\n
Please output only the complete rewritten email content, without any extra explanation.`;
                }
            } catch (e) {
                outputArea.innerHTML = `<p class="text-red-600 text-center py-10">${e.message}</p>`;
                submitButton.disabled = false;
                return;
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                const generatedText = candidate?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputArea.textContent = generatedText;
                } else {
                    throw new Error(translations[currentLanguage]['mentor-error-api-empty'] || "API è¿”å›äº†ç©ºå†…å®¹æˆ–ç»“æ„å¼‚å¸¸ã€‚");
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                errorMessage.querySelector('span').textContent = `${translations[currentLanguage]['mentor-error-processing'] || 'å¤„ç†å¤±è´¥'}: ${error.message || (translations[currentLanguage]['mentor-error-network'] || 'ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡å¼‚å¸¸ã€‚')}`;
                errorMessage.classList.remove('hidden');
                outputArea.innerHTML = `<p class="text-red-600 text-center py-10" data-lang-key="mentor-error-ui-failed">AI å¤„ç†è¯·æ±‚æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åå†è¯•ã€‚</p>`;
            } finally {
                submitButton.disabled = false;
            }
        }

        // ç»‘å®šäº‹ä»¶
        submitButton.addEventListener('click', handleEmailProcessing);
    </script>
</body>
</html>