<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶å†™ä½œå¯¼å¸ˆ (Email Writing Mentor)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* é’ˆå¯¹ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–ï¼Œç¡®ä¿ä¸»ä½“å†…å®¹å±…ä¸­ä¸”ä¸æ‹¥æŒ¤ */
        .main-container {
            max-width: 95%;
            margin: 0 auto;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .main-container {
                max-width: 768px; /* md screen size */
                padding: 2rem;
            }
        }
        .loading-animation {
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <header class="text-center py-6 bg-white rounded-xl shadow-lg mt-4 mb-8">
            <h1 id="page-title" class="text-3xl font-bold text-gray-900">é‚®ä»¶å†™ä½œå¯¼å¸ˆ ğŸ“§</h1>
            <p id="page-subtitle" class="mt-2 text-gray-500">ä¸€ç«™å¼è§£å†³èŒåœºå’Œå­¦æœ¯é‚®ä»¶éš¾é¢˜</p>
        </header>

        <!-- ä¸»é¢æ¿ -->
        <div id="email-app" class="flex flex-col lg:flex-row gap-6">
            
            <!-- å·¦ä¾§ï¼šè¾“å…¥æ§åˆ¶é¢æ¿ -->
            <div class="lg:w-1/3 p-4 bg-white rounded-xl shadow-lg h-full sticky top-4">
                <h2 id="params-title" class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">å†™ä½œå‚æ•°</h2>
                
                <!-- æ¨¡å¼é€‰æ‹© -->
                <div class="mb-5">
                    <label id="mode-label" class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©åŠŸèƒ½</label>
                    <select id="mode-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                        <option value="generate">ç”Ÿæˆæ–°è‰ç¨¿ (Generate)</option>
                        <option value="analyze">åˆ†æå’Œå»ºè®® (Analyze)</option>
                        <option value="refine">æ¶¦è‰²å’Œé‡å†™ (Refine)</option>
                    </select>
                </div>
                
                <!-- ä»…ç”Ÿæˆæ¨¡å¼å¯è§çš„å­—æ®µ -->
                <div id="generate-fields">
                    <div class="mb-5">
                        <label id="recipient-label" for="recipient-select" class="block text-sm font-medium text-gray-700 mb-2">æ”¶ä»¶äºº/æƒ…å¢ƒ</label>
                        <select id="recipient-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Professor">æ•™æˆ/å¯¼å¸ˆ (Professor/Mentor)</option>
                            <option value="Manager">ç»ç†/è€æ¿ (Manager/Boss)</option>
                            <option value="Client">å®¢æˆ·/å¤–éƒ¨åˆä½œæ–¹ (Client/Partner)</option>
                            <option value="Colleague">åŒäº‹/åŒå­¦ (Colleague/Classmate)</option>
                            <option value="Job Application">æ±‚èŒç”³è¯· (Job Application)</option>
                            <option value="Complaint/Request">æŠ•è¯‰/æ­£å¼è¯·æ±‚ (Complaint/Request)</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label id="tone-label" for="tone-select" class="block text-sm font-medium text-gray-700 mb-2">æœŸæœ›è¯­æ°”</label>
                        <select id="tone-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Formal">æ­£å¼ã€ä¸“ä¸š (Formal, Professional)</option>
                            <option value="Casual">éæ­£å¼ã€è½»æ¾ (Casual, Friendly)</option>
                            <option value="Persuasive">è¯´æœæ€§ã€æœ‰æ¡ç† (Persuasive, Organized)</option>
                            <option value="Concise">ç®€æ´ã€ç›´æ¥ (Concise, Direct)</option>
                            <option value="Apologetic">è‡´æ­‰ã€è¯šæ³ (Apologetic, Sincere)</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label id="intent-label" for="prompt-input" class="block text-sm font-medium text-gray-700 mb-2">é‚®ä»¶æ„å›¾ï¼ˆè¯´æ˜ä½ çš„ç›®çš„ï¼‰</label>
                        <textarea id="prompt-input" rows="4" placeholder="ä¾‹å¦‚ï¼šè¯·æ±‚æ•™æˆå»¶é•¿æ¯•ä¸šè®ºæ–‡æäº¤æœŸé™ï¼Œå¹¶è¯´æ˜åŸå› ã€‚" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow"></textarea>
                    </div>
                </div>

                <!-- ä»…åˆ†æ/æ¶¦è‰²æ¨¡å¼å¯è§çš„å­—æ®µ -->
                <div id="draft-fields" class="hidden">
                     <div class="mb-5">
                        <label id="draft-label" for="draft-textarea" class="block text-sm font-medium text-gray-700 mb-2">ç²˜è´´æ‚¨çš„é‚®ä»¶è‰ç¨¿</label>
                        <textarea id="draft-textarea" rows="8" placeholder="ç²˜è´´å®Œæ•´çš„é‚®ä»¶å†…å®¹ï¼ŒåŒ…æ‹¬ä¸»é¢˜å’Œæ­£æ–‡..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow"></textarea>
                    </div>
                    <!-- ä»…æ¶¦è‰²æ¨¡å¼å¯è§çš„å­—æ®µ -->
                    <div class="mb-5 hidden" id="refinement-field">
                        <label id="refinement-label" for="refinement-prompt" class="block text-sm font-medium text-gray-700 mb-2">æ¶¦è‰²è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <input id="refinement-prompt" type="text" placeholder="ä¾‹å¦‚ï¼šè®©è¯­æ°”æ›´å§”å©‰ï¼›å°†é‚®ä»¶ç¼©çŸ­åˆ°100å­—ä»¥å†…" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                    </div>
                </div>


                <!-- æäº¤æŒ‰é’® -->
                <button id="submit-button" class="w-full bg-orange-600 text-white p-3 rounded-xl font-semibold hover:bg-orange-700 transition-colors shadow-md" data-lang-key="submit-btn">
                    å¼€å§‹å¤„ç†
                </button>
            </div>

            <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒº -->
            <div class="lg:w-2/3">
                <div class="p-6 bg-white rounded-xl shadow-lg min-h-[300px]">
                    <h2 id="output-title" class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">è¾“å‡ºç»“æœ</h2>
                    
                    <!-- ç»“æœæ˜¾ç¤º/åŠ è½½ä¸­ -->
                    <div id="output-area" class="text-gray-700 whitespace-pre-wrap leading-relaxed">
                        <p id="output-placeholder" class="text-gray-500 text-center py-10">è¯·åœ¨å·¦ä¾§é€‰æ‹©æ¨¡å¼å¹¶è¾“å…¥å‚æ•°ï¼Œç„¶åç‚¹å‡» "å¼€å§‹å¤„ç†" æŒ‰é’®ã€‚</p>
                    </div>

                    <!-- é”™è¯¯ä¿¡æ¯ -->
                    <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase é…ç½®å’Œåˆå§‹åŒ– (è™½ç„¶æœ¬åº”ç”¨ä¸ä½¿ç”¨ Firestoreï¼Œä½†ä¸ºäº†ç¬¦åˆ Canvas è§„èŒƒï¼Œä¿ç•™åˆå§‹åŒ–) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        // ä»…ç”¨äºæ»¡è¶³ Canvas åˆå§‹åŒ–çš„è¦æ±‚ï¼Œæœ¬åº”ç”¨ä¸ä¾èµ–äº Firestore æˆ– Auth çŠ¶æ€
        if (firebaseConfig) {
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                const initAuth = async () => {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase auth initialized.");
                };
                initAuth();
            } catch (e) {
                console.error("Firebase init failed:", e);
            }
        }
        
        // --- æ ¸å¿ƒ JavaScript é€»è¾‘ ---

        // --- è¯­è¨€åˆ‡æ¢é€»è¾‘ ---
        const translations = {
            zh: {
                'page-title': 'é‚®ä»¶å†™ä½œå¯¼å¸ˆ ğŸ“§',
                'page-subtitle': 'ä¸€ç«™å¼è§£å†³èŒåœºå’Œå­¦æœ¯é‚®ä»¶éš¾é¢˜',
                'params-title': 'å†™ä½œå‚æ•°',
                'mode-label': 'é€‰æ‹©åŠŸèƒ½',
                'recipient-label': 'æ”¶ä»¶äºº/æƒ…å¢ƒ',
                'tone-label': 'æœŸæœ›è¯­æ°”',
                'intent-label': 'é‚®ä»¶æ„å›¾ï¼ˆè¯´æ˜ä½ çš„ç›®çš„ï¼‰',
                'draft-label': 'ç²˜è´´æ‚¨çš„é‚®ä»¶è‰ç¨¿',
                'refinement-label': 'æ¶¦è‰²è¦æ±‚ï¼ˆå¯é€‰ï¼‰',
                'submit-btn': 'å¼€å§‹å¤„ç†',
                'output-title': 'è¾“å‡ºç»“æœ',
                'output-placeholder': 'è¯·åœ¨å·¦ä¾§é€‰æ‹©æ¨¡å¼å¹¶è¾“å…¥å‚æ•°ï¼Œç„¶åç‚¹å‡» "å¼€å§‹å¤„ç†" æŒ‰é’®ã€‚',
                'loading-text': 'AI æ­£åœ¨åŠªåŠ›æ’°å†™ä¸­...',
                'error-intent': 'è¯·è¾“å…¥é‚®ä»¶æ„å›¾ã€‚',
                'error-draft': 'è¯·ç²˜è´´è¦åˆ†æçš„é‚®ä»¶è‰ç¨¿ã€‚',
            },
            ko: {
                'page-title': 'ì´ë©”ì¼ ì‘ì„± ë©˜í†  ğŸ“§',
                'page-subtitle': 'ì§ì¥ ë° í•™ìˆ  ì´ë©”ì¼ ë¬¸ì œ ì›ìŠ¤í†± í•´ê²°',
                'params-title': 'ì‘ì„± íŒŒë¼ë¯¸í„°',
                'mode-label': 'ê¸°ëŠ¥ ì„ íƒ',
                'recipient-label': 'ìˆ˜ì‹ ì/ìƒí™©',
                'tone-label': 'ì›í•˜ëŠ” í†¤',
                'intent-label': 'ì´ë©”ì¼ ëª©ì  (ëª©ì  ì„¤ëª…)',
                'draft-label': 'ì´ë©”ì¼ ì´ˆì•ˆ ë¶™ì—¬ë„£ê¸°',
                'refinement-label': 'ìˆ˜ì • ìš”êµ¬ì‚¬í•­ (ì„ íƒ ì‚¬í•­)',
                'submit-btn': 'ì²˜ë¦¬ ì‹œì‘',
                'output-title': 'ì¶œë ¥ ê²°ê³¼',
                'output-placeholder': 'ì™¼ìª½ì—ì„œ ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  íŒŒë¼ë¯¸í„°ë¥¼ ì…ë ¥í•œ í›„ "ì²˜ë¦¬ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
                'loading-text': 'AIê°€ ì—´ì‹¬íˆ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...',
                'error-intent': 'ì´ë©”ì¼ ëª©ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                'error-draft': 'ë¶„ì„í•  ì´ë©”ì¼ ì´ˆì•ˆì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.',
            }
        };

        function setLanguage(lang) {
            const t = translations[lang];
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = t[key];
                }
            });
            // æ›´æ–°å ä½ç¬¦
            document.getElementById('prompt-input').placeholder = lang === 'ko' ? 'ì˜ˆ: êµìˆ˜ë‹˜ê»˜ ì¡¸ì—… ë…¼ë¬¸ ì œì¶œ ê¸°í•œ ì—°ì¥ì„ ìš”ì²­í•˜ê³  ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.' : 'ä¾‹å¦‚ï¼šè¯·æ±‚æ•™æˆå»¶é•¿æ¯•ä¸šè®ºæ–‡æäº¤æœŸé™ï¼Œå¹¶è¯´æ˜åŸå› ã€‚';
        }
        
        // API å¯†é’¥å’Œ URLï¼ˆåœ¨ Canvas ç¯å¢ƒä¸­ä¼šè‡ªåŠ¨æä¾›ï¼‰
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // å…ƒç´ å¼•ç”¨
        const modeSelect = document.getElementById('mode-select');
        const generateFields = document.getElementById('generate-fields');
        const draftFields = document.getElementById('draft-fields');
        const refinementField = document.getElementById('refinement-field');
        const submitButton = document.getElementById('submit-button');
        const outputArea = document.getElementById('output-area');
        const errorMessage = document.getElementById('error-message');

        const recipientSelect = document.getElementById('recipient-select');
        const toneSelect = document.getElementById('tone-select');
        const promptInput = document.getElementById('prompt-input');
        const draftTextarea = document.getElementById('draft-textarea');
        const refinementPrompt = document.getElementById('refinement-prompt');

        // --- UI çŠ¶æ€ç®¡ç† ---
        modeSelect.addEventListener('change', () => {
            const mode = modeSelect.value;
            generateFields.classList.add('hidden');
            draftFields.classList.add('hidden');
            refinementField.classList.add('hidden');

            if (mode === 'generate') {
                generateFields.classList.remove('hidden');
            } else {
                draftFields.classList.remove('hidden');
                if (mode === 'refine') {
                    refinementField.classList.remove('hidden');
                }
            }
            outputArea.innerHTML = `<p id="output-placeholder" class="text-gray-500 text-center py-10">${translations[localStorage.getItem('writeflow_language') || 'zh']['output-placeholder']}</p>`;
        });

        // åˆå§‹åŒ–UI
        modeSelect.dispatchEvent(new Event('change'));

        // --- API è°ƒç”¨å’Œä¸»é€»è¾‘ ---
        let retryCount = 0;
        const MAX_RETRIES = 5;

        async function fetchWithRetry(payload) {
            let delay = 1000;
            while (retryCount < MAX_RETRIES) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        retryCount = 0; // é‡ç½®è®¡æ•°å™¨
                        return response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        // å¤„ç†é€Ÿç‡é™åˆ¶å’ŒæœåŠ¡å™¨é”™è¯¯
                        throw new Error(`API Error: ${response.status}`);
                    } else {
                         // å…¶ä»–å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¸é‡è¯•
                        console.error("Non-retryable API error:", response.status);
                        return response.json();
                    }
                } catch (error) {
                    retryCount++;
                    if (retryCount >= MAX_RETRIES) {
                        throw new Error("APIè¯·æ±‚å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚");
                    }
                    console.log(`Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // æŒ‡æ•°é€€é¿
                }
            }
        }

        async function handleEmailProcessing() {
            errorMessage.classList.add('hidden');
            outputArea.innerHTML = `<div class="flex flex-col items-center justify-center py-10">
                                        <div class="loading-animation w-8 h-8 border-4 border-orange-500 rounded-full mb-3"></div>
                                        <p class="text-orange-600 font-medium">AI æ­£åœ¨åŠªåŠ›æ’°å†™ä¸­...</p>
                                    </div>`;
            submitButton.disabled = true;

            const mode = modeSelect.value;
            let systemPrompt = "";
            let userQuery = "";
            
            const currentLang = localStorage.getItem('writeflow_language') || 'zh';
            // --- æ„é€ æç¤ºè¯å’Œç³»ç»ŸæŒ‡ä»¤ ---
            try {
                if (mode === 'generate') {
                    const recipient = recipientSelect.value;
                    const tone = toneSelect.value;
                    const intent = promptInput.value.trim();
                    
                    if (!intent) throw new Error(translations[currentLang]['error-intent']);

                    systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‚®ä»¶å†™ä½œåŠ©ç†ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„æ„å›¾ã€æ”¶ä»¶äººå’Œè¯­æ°”ï¼Œç”Ÿæˆä¸€å°å®Œæ•´ã€ç»“æ„æ¸…æ™°ä¸”å¾—ä½“çš„é‚®ä»¶ï¼ˆåŒ…æ‹¬ä¸»é¢˜ã€ç§°è°“ã€æ­£æ–‡å’Œç½²åï¼‰ã€‚æ‰€æœ‰è¾“å‡ºå¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚";
                    userQuery = `è¯·ä¸ºä»¥ä¸‹æƒ…å¢ƒæ’°å†™é‚®ä»¶ï¼š
- æ”¶ä»¶äºº/æƒ…å¢ƒ: ${recipient}
- æœŸæœ›è¯­æ°”: ${tone}
- æ„å›¾è¯´æ˜: ${intent}
è¯·ç›´æ¥è¾“å‡ºé‚®ä»¶å†…å®¹ï¼Œä¸éœ€è¦é¢å¤–è¯´æ˜ã€‚`;
                } else if (mode === 'analyze') {
                    const draft = draftTextarea.value.trim();
                    if (!draft) throw new Error(translations[currentLang]['error-draft']);

                    systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‚®ä»¶åˆ†æå¸ˆã€‚è¯·å¯¹ç”¨æˆ·æä¾›çš„é‚®ä»¶è‰ç¨¿è¿›è¡Œå…¨é¢è¯„ä¼°ã€‚è¯„ä¼°å†…å®¹åŒ…æ‹¬ï¼šä¸»é¢˜æ¸…æ™°åº¦ã€è¯­æ°”å¾—ä½“æ€§ã€æ­£æ–‡ç»“æ„å’Œè¯­è¨€çš„ä¸“ä¸šåº¦ã€‚è¯·ä»¥'é‚®ä»¶åˆ†ææŠ¥å‘Š'å¼€å¤´ï¼Œç„¶åæä¾›ä¸€ä¸ªæ•´ä½“è¯„ä»·ï¼Œæœ€åç”¨**åˆ†ç‚¹åˆ—è¡¨**ç»™å‡º3-5æ¡å…·ä½“çš„ä¿®æ”¹å»ºè®®ã€‚";
                    userQuery = `è¯·åˆ†æå¹¶ç»™å‡ºæ”¹è¿›å»ºè®®:\n\n${draft}`;

                } else if (mode === 'refine') {
                    const draft = draftTextarea.value.trim();
                    const refinement = refinementPrompt.value.trim() || "æ¶¦è‰²ï¼Œä½¿å…¶æ›´æµç•…ã€æ›´ä¸“ä¸š";
                    if (!draft) throw new Error(translations[currentLang]['error-draft']);
                    
                    systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‚®ä»¶æ¶¦è‰²ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è¦æ±‚ï¼Œé‡å†™å¹¶ä¼˜åŒ–ç”¨æˆ·æä¾›çš„é‚®ä»¶ã€‚ç¡®ä¿é‡å†™åçš„é‚®ä»¶ç»“æ„å®Œæ•´ï¼Œè¯­æ°”å¾—ä½“ã€‚";
                    userQuery = `è¯·æ ¹æ®ä»¥ä¸‹è¦æ±‚é‡å†™é‚®ä»¶:\n
- åŸå§‹é‚®ä»¶:\n${draft}\n
- æ¶¦è‰²è¦æ±‚: ${refinement}\n
è¯·ç›´æ¥è¾“å‡ºé‡å†™åçš„å®Œæ•´é‚®ä»¶å†…å®¹ï¼Œä¸éœ€è¦é¢å¤–è¯´æ˜ã€‚`;
                }
            } catch (e) {
                outputArea.innerHTML = `<p class="text-red-600 text-center py-10">${e.message}</p>`;
                submitButton.disabled = false;
                return;
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                const generatedText = candidate?.content?.parts?.[0]?.text;

                if (generatedText) {
                    // å°† Markdown æ ¼å¼çš„è¾“å‡ºè½¬æ¢ä¸º HTML
                    const formattedHtml = formatAsHtml(generatedText);
                    outputArea.innerHTML = formattedHtml;
                } else {
                    throw new Error("API è¿”å›äº†ç©ºå†…å®¹æˆ–ç»“æ„å¼‚å¸¸ã€‚");
                }
            } catch (error) {
                console.error("Gemini APIè°ƒç”¨å¤±è´¥:", error);
                errorMessage.textContent = `å¤„ç†å¤±è´¥: ${error.message || 'ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡å¼‚å¸¸ã€‚'}`;
                errorMessage.classList.remove('hidden');
                outputArea.innerHTML = `<p class="text-red-600 text-center py-10">AI å¤„ç†è¯·æ±‚æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åå†è¯•ã€‚</p>`;
            } finally {
                submitButton.disabled = false;
            }
        }

        // ç®€æ˜“ Markdown åˆ° HTML è½¬æ¢å‡½æ•° (ç”¨äºç¾åŒ–è¾“å‡º)
        function formatAsHtml(text) {
            // ç²—ä½“
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // æ ‡é¢˜ (H2)
            html = html.replace(/^##\s*(.*)$/gm, '<h3 class="text-xl font-bold mt-4 mb-2">$1</h3>');
            // æ ‡é¢˜ (H3)
            html = html.replace(/^#\s*(.*)$/gm, '<h2 class="text-2xl font-bold mt-4 mb-2">$1</h2>');
            // åˆ—è¡¨
            html = html.replace(/^\*\s*(.*)$/gm, '<li class="list-disc ml-6">$1</li>');
            html = html.replace(/<li>/g, '<ul>$&</ul>');
            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');
            
            // ç§»é™¤å¤šä½™çš„ <ul> æ ‡ç­¾åµŒå¥—
            html = html.replace(/<\/ul><ul>/g, '');

            // åŒ…è£¹æ®µè½
            html = html.replace(/^(?!<h|ul|li|strong>)(.*?)<br>/gm, '<p class="mb-3">$1</p>');
            
            return html;
        }


        // ç»‘å®šäº‹ä»¶
        submitButton.addEventListener('click', handleEmailProcessing);

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¯­è¨€
        document.addEventListener('DOMContentLoaded', () => {
            const savedLanguage = localStorage.getItem('writeflow_language') || 'zh';
            setLanguage(savedLanguage);
        });
    </script>
</body>
</html>